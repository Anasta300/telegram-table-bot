import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackContext, CallbackQueryHandler
import time
import requests
from datetime import datetime, timedelta

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
BOT_TOKEN = "8345014495:AAGjAMly1nCRqoPHJYDhRaQ_o4WXSiVUC6o"
YMONEY_TOKEN = "4100118649982446.F39857C0F941EA599188546D1EACBF05E9B0B51FD7646815F39B552714C0ADC7968093E2EB68A8322F886F3806ED4D78A4CEBB29366DABCE5D07ED0C271D22CE474046FD80B78004AD68CE73F6FC6B2FE0070097DD112493173ADF6362556B54C742E83E7A7572F7EC9A65B4AF8AFA37545436C507CA0C087135155E16E91710"
YMONEY_WALLET = "4100118649982446"

# üîó –°–°–´–õ–ö–ò –ù–ê –¢–ê–ë–õ–ò–¶–´
DEMO_SHEET_URL = "https://docs.google.com/spreadsheets/d/1oUXk621AL0fVQoMCq29Th7J2gi855l__/edit?usp=sharing&ouid=118098768944350332547&rtpof=true&sd=true"  # –î–µ–º–æ (—Å–æ–∫—Ä–∞—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
FULL_SHEET_URL = "https://docs.google.com/spreadsheets/d/1aQdZNhSiNOzDHet0ocN6ftD16Wi9FT6Z/edit?usp=sharing&ouid=118098768944350332547&rtpof=true&sd=true"  # –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–∏
EXPECTED_AMOUNT = 300
MIN_AMOUNT = 291

# üîß –ù–ê–°–¢–†–û–ô–ö–ê –ê–î–ú–ò–ù–ê
ADMIN_ID = 895676610
# ==============================

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

orders = {}

async def start(update: Update, context: CallbackContext) -> None:
    user_id = update.effective_user.id
    user_name = update.effective_user.first_name
    order_id = f"{user_id}_{int(time.time())}"
    comment = f"table_{order_id}"
    
    orders[order_id] = {
        'user_id': user_id,
        'expected_amount': EXPECTED_AMOUNT,
        'min_amount': MIN_AMOUNT,
        'comment': comment,
        'paid': False,
        'created_at': time.time()
    }
    
    payment_url = f"https://yoomoney.ru/quickpay/confirm?receiver={YMONEY_WALLET}&sum={EXPECTED_AMOUNT}&quickpay-form=shop&label={comment}"
    
    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏
    keyboard = [
        [InlineKeyboardButton("üìä –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è", url=DEMO_SHEET_URL)],
        [InlineKeyboardButton("üí≥ –ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é - 300 —Ä—É–±", url=payment_url)],
        [InlineKeyboardButton("‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É", callback_data=f"check_{order_id}")]
    ]
    
    # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –¥–µ–º–æ –∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞—Ö –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    await update.message.reply_text(
        f"üëã –î–æ–±—Ä—ã–π –¥–µ–Ω—å, {user_name}!\n\n"
        f"*–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è*\n"
        f"‚Ä¢ –û–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ç–∞–±–ª–∏—Ü—ã\n"
        f"‚Ä¢ –°–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã\n"
        f"‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–∞ —Å—Ä–∞–∑—É\n\n"
        f"*–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –∑–∞ {EXPECTED_AMOUNT} —Ä—É–±*\n"
        f"‚Ä¢ ‚úÖ –í—Å–µ 3 —Ä–∞–∑–¥–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã\n"
        f"‚Ä¢ ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n"
        f"‚Ä¢ ‚úÖ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞–≤—Å–µ–≥–¥–∞\n\n"
        f"üéØ *–ü–æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –¥–µ–º–æ-–≤–µ—Ä—Å–∏–µ–π, –∏ –µ—Å–ª–∏ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è - –ø—Ä–∏–æ–±—Ä–µ—Ç–∞–π—Ç–µ –ø–æ–ª–Ω—É—é!*\n\n"
        f"–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É.",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

async def check_yoomoney_payment(order_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–ª–∞—Ç–µ–∂ –ø–æ —Å—É–º–º–µ –∏ –≤—Ä–µ–º–µ–Ω–∏ (–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è)"""
    try:
        order = orders.get(order_id)
        if not order:
            print(f"‚ùå –ó–∞–∫–∞–∑ {order_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False
        
        print(f"üîç –ò—â–µ–º –ø–ª–∞—Ç–µ–∂ –¥–ª—è –∑–∞–∫–∞–∑–∞ {order_id}")
        print(f"   –û–∂–∏–¥–∞–µ–º–∞—è —Å—É–º–º–∞: {order['expected_amount']} —Ä—É–±")
        print(f"   –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: {order['min_amount']} —Ä—É–±")
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥ –ø–æ–∏—Å–∫–∞ –¥–æ 24 —á–∞—Å–æ–≤ –∑–∞–º–µ–Ω–∏–ª–∞ –Ω–∞ 1 —á–∞—Å 
        to_date = datetime.now()
        from_date = to_date - timedelta(hours=1)
        from_date_str = from_date.strftime("%Y-%m-%dT%H:%M:%SZ")
        to_date_str = to_date.strftime("%Y-%m-%dT%H:%M:%SZ")
        
        headers = {'Authorization': f'Bearer {YMONEY_TOKEN}'}
        params = {
            'type': 'deposition',
            'from': from_date_str,
            'till': to_date_str,
            'records': '50'
        }
        
        response = requests.post(
            'https://yoomoney.ru/api/operation-history',
            headers=headers,
            data=params
        )
        
        print(f"üìä –°—Ç–∞—Ç—É—Å API: {response.status_code}")
        
        if response.status_code == 200:
            operations = response.json().get('operations', [])
            print(f"üìã –ù–∞–π–¥–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π: {len(operations)}")
            
            # –ò—â–µ–º –ø–ª–∞—Ç–µ–∂ —Ç–æ–ª—å–∫–æ –ø–æ —Å—É–º–º–µ –∏ —Å—Ç–∞—Ç—É—Å—É (–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è)
            for operation in operations:
                op_amount = float(operation.get('amount', 0))
                op_status = operation.get('status', '')
                op_direction = operation.get('direction', '')
                
                print(f"üîé –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é: {op_amount} —Ä—É–±, —Å—Ç–∞—Ç—É—Å: {op_status}")
                
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Å—É–º–º–µ (–≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ) –∏ —Å—Ç–∞—Ç—É—Å—É
                if (order['min_amount'] <= op_amount <= order['expected_amount'] and
                    op_status == 'success' and
                    op_direction == 'in'):
                    
                    print(f"‚úÖ –ù–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–ª–∞—Ç–µ–∂! –°—É–º–º–∞: {op_amount} —Ä—É–±")
                    return True
            
            print("‚ùå –ü–æ–¥—Ö–æ–¥—è—â–∏–π –ø–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            
        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ API: {response.status_code}")
            print(f"–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏: {response.text}")
            
        return False
        
    except Exception as e:
        print(f"üí• –û—à–∏–±–∫–∞: {e}")
        return False

async def button_handler(update: Update, context: CallbackContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""
    query = update.callback_query
    await query.answer()
    
    if query.data.startswith("check_"):
        order_id = query.data.replace("check_", "")
        
        order = orders.get(order_id)
        if order and (time.time() - order['created_at']) < 30:
            await query.answer("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã", show_alert=True)
            return
        
        checking_msg = await query.message.reply_text("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É...")
        is_paid = await check_yoomoney_payment(order_id)
        await context.bot.delete_message(chat_id=query.message.chat_id, message_id=checking_msg.message_id)
        
        if is_paid:
            orders[order_id]['paid'] = True
            await query.message.reply_text(
                f"‚úÖ *–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!*\n\n"
                f"üíé *–í–æ—Ç –≤–∞—à–∞ –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ç–∞–±–ª–∏—Ü—ã:*\n{FULL_SHEET_URL}\n\n"
                f"üìö *–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é:*\n"
                f"‚Ä¢ –í—Å–µ 3 —Ä–∞–∑–¥–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã\n"
                f"‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n"
                f"‚Ä¢ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞–≤—Å–µ–≥–¥–∞\n\n"
                f"–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è! üìä",
                parse_mode='Markdown'
            )
        else:
            keyboard = [[InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—â–µ —Ä–∞–∑", callback_data=f"check_{order_id}")]]
            await query.message.reply_text(
                "‚ùå *–û–ø–ª–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.*\n\n"
                "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                "‚Ä¢ –ü–ª–∞—Ç–µ–∂ –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è (1-5 –º–∏–Ω—É—Ç)\n"
                "‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å API\n\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –ø–∞—Ä—É –º–∏–Ω—É—Ç:",
                reply_markup=InlineKeyboardMarkup(keyboard),
                parse_mode='Markdown'
            )

async def adjust_commission(update: Update, context: CallbackContext) -> None:
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    user_id = update.effective_user.id
    
    if user_id != ADMIN_ID:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
        return
    
    if context.args:
        try:
            new_min_amount = int(context.args[0])
            global MIN_AMOUNT
            MIN_AMOUNT = new_min_amount
            await update.message.reply_text(f"‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ {MIN_AMOUNT} —Ä—É–±")
        except ValueError:
            await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /commission <—Å—É–º–º–∞>")
    else:
        await update.message.reply_text(
            f"üìä –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–∏:\n"
            f"–û–∂–∏–¥–∞–µ–º–∞—è —Å—É–º–º–∞: {EXPECTED_AMOUNT} —Ä—É–±\n"
            f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: {MIN_AMOUNT} —Ä—É–±\n\n"
            f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /commission <–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è_—Å—É–º–º–∞>"
        )

async def get_my_id(update: Update, context: CallbackContext) -> None:
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ Telegram ID"""
    user_id = update.effective_user.id
    await update.message.reply_text(f"üÜî –í–∞—à Telegram ID: `{user_id}`", parse_mode='Markdown')

def main():
    print("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ —Å –¥–µ–º–æ-–≤–µ—Ä—Å–∏–µ–π –∏ –ø–æ–ª–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π")
    print(f"üí∞ –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è: {EXPECTED_AMOUNT} —Ä—É–±")
    print(f"üìâ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: {MIN_AMOUNT} —Ä—É–±")
    print(f"üîó –î–µ–º–æ-–≤–µ—Ä—Å–∏—è: {DEMO_SHEET_URL}")
    print(f"üîó –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è: {FULL_SHEET_URL}")
    print(f"üëë Admin ID: {ADMIN_ID}")
    
    application = Application.builder().token(BOT_TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("commission", adjust_commission))
    application.add_handler(CommandHandler("myid", get_my_id))
    application.add_handler(CallbackQueryHandler(button_handler))
    
    application.run_polling()

if __name__ == "__main__":
    main()
