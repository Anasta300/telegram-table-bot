import os
import logging
import threading
import time
import requests
from datetime import datetime, timedelta
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackContext, CallbackQueryHandler
from flask import Flask, jsonify
from apscheduler.schedulers.background import BackgroundScheduler

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.environ.get('BOT_TOKEN', '8345014495:AAGjAMly1nCRqoPHJYDhRaQ_o4WXSiVUC6o')
YMONEY_TOKEN = os.environ.get('YMONEY_TOKEN', '4100118649982446.F39857C0F941EA599188546D1EACBF05E9B0B51FD7646815F39B552714C0ADC7968093E2EB68A8322F886F3806ED4D78A4CEBB29366DABCE5D07ED0C271D22CE474046FD80B78004AD68CE73F6FC6B2FE0070097DD112493173ADF6362556B54C742E83E7A7572F7EC9A65B4AF8AFA37545436C507CA0C087135155E16E91710')
YMONEY_WALLET = os.environ.get('YMONEY_WALLET', '4100118649982446')
ADMIN_ID = int(os.environ.get('ADMIN_ID', '895676610'))

# üîó –°–°–´–õ–ö–ò –ù–ê –¢–ê–ë–õ–ò–¶–´
DEMO_SHEET_URL = "https://docs.google.com/spreadsheets/d/1oUXk621AL0fVQoMCq29Th7J2gi855l__/preview"
FULL_SHEET_URL = "https://docs.google.com/spreadsheets/d/1aQdZNhSiNOzDHet0ocN6ftD16Wi9FT6Z/edit?usp=sharing&ouid=118098768944350332547&rtpof=true&sd=true"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–∏
EXPECTED_AMOUNT = 300
MIN_AMOUNT = 291
# ==============================

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Flask –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
app = Flask(__name__)

# –°–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
orders = {}

# –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–ø—É—Å–∫–∞
app_start_time = time.time()

# ========== SELF-PING –ú–ï–•–ê–ù–ò–ó–ú ==========
def self_ping():
    """–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π self-ping –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç"""
    try:
        # –ü–æ–ª—É—á–∞–µ–º URL —Ç–µ–∫—É—â–µ–≥–æ Replit –ø—Ä–æ–µ–∫—Ç–∞
        repl_slug = os.environ.get('REPL_SLUG', 'telegram-table-bot-belivernast')
        bot_url = f"https://{repl_slug}.replit.app"
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —Å–∞–º–æ–º—É —Å–µ–±–µ
        response = requests.get(f"{bot_url}/ping", timeout=10)
        if response.status_code == 200:
            logger.info(f"‚úÖ Self-ping –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ: {response.text}")
        else:
            logger.warning(f"‚ö†Ô∏è Self-ping –≤–µ—Ä–Ω—É–ª –∫–æ–¥ {response.status_code}")
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è Self-ping –Ω–µ —É–¥–∞–ª—Å—è: {str(e)}")

# –°–æ–∑–¥–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è self-ping
scheduler = BackgroundScheduler()
scheduler.add_job(self_ping, 'interval', minutes=10)
scheduler.start()
logger.info("üîÑ Self-ping –º–µ—Ö–∞–Ω–∏–∑–º –∑–∞–ø—É—â–µ–Ω (–∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç)")

# ========== FLASK –≠–ù–î–ü–û–ò–ù–¢–´ ==========
@app.route('/')
def home():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    return "ü§ñ –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç! –°—Ç–∞—Ç—É—Å: ONLINE", 200

@app.route('/health')
def health():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞"""
    return jsonify({
        "status": "online",
        "timestamp": datetime.now().isoformat(),
        "uptime": round(time.time() - app_start_time, 2),
        "orders_count": len(orders),
        "self_ping": "active"
    }), 200

@app.route('/ping')
def ping():
    """–ü—Ä–æ—Å—Ç–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è ping"""
    return "pong", 200

@app.route('/wakeup')
def wakeup():
    """–≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è"""
    return jsonify({
        "status": "awake",
        "message": "Bot is awake and running",
        "timestamp": datetime.now().isoformat()
    }), 200

@app.route('/status')
def status_page():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞"""
    return jsonify({
        "service": "Telegram Table Bot",
        "status": "running",
        "version": "1.0",
        "orders_processed": len(orders),
        "last_ping": datetime.now().isoformat()
    }), 200

# ========== TELEGRAM –ë–û–¢ –§–£–ù–ö–¶–ò–ò ==========
async def start(update: Update, context: CallbackContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.effective_user.id
    user_name = update.effective_user.first_name
    order_id = f"{user_id}_{int(time.time())}"
    comment = f"table_{order_id}"
    
    orders[order_id] = {
        'user_id': user_id,
        'expected_amount': EXPECTED_AMOUNT,
        'min_amount': MIN_AMOUNT,
        'comment': comment,
        'paid': False,
        'created_at': time.time()
    }
    
    payment_url = f"https://yoomoney.ru/quickpay/confirm?receiver={YMONEY_WALLET}&sum={EXPECTED_AMOUNT}&quickpay-form=shop&label={comment}"
    
    keyboard = [
        [InlineKeyboardButton("üìä –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è", url=DEMO_SHEET_URL)],
        [InlineKeyboardButton("üí≥ –ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é - 300 —Ä—É–±", url=payment_url)],
        [InlineKeyboardButton("‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É", callback_data=f"check_{order_id}")]
    ]
    
    await update.message.reply_text(
        f"üëã –î–æ–±—Ä—ã–π –¥–µ–Ω—å, {user_name}!\n\n"
        f"üìä *–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è*\n"
        f"‚Ä¢ –û–∑–Ω–∞–∫–æ–º–∏—Ç–µ–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Ç–∞–±–ª–∏—Ü—ã\n"
        f"‚Ä¢ –°–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã\n"
        f"‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–∞ —Å—Ä–∞–∑—É\n\n"
        f"üíé *–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è –∑–∞ {EXPECTED_AMOUNT} —Ä—É–±*\n"
        f"‚Ä¢ ‚úÖ –í—Å–µ 3 —Ä–∞–∑–¥–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã\n"
        f"‚Ä¢ ‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n"
        f"‚Ä¢ ‚úÖ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞–≤—Å–µ–≥–¥–∞\n\n"
        f"üéØ *–ü–æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å –¥–µ–º–æ-–≤–µ—Ä—Å–∏–µ–π, –∏ –µ—Å–ª–∏ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è - –ø—Ä–∏–æ–±—Ä–µ—Ç–∞–π—Ç–µ –ø–æ–ª–Ω—É—é!*\n\n"
        f"–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ '‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É'.",
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode='Markdown'
    )

async def check_yoomoney_payment(order_id):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–ª–∞—Ç–µ–∂ –ø–æ —Å—É–º–º–µ –∏ –≤—Ä–µ–º–µ–Ω–∏ (–±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è)"""
    try:
        order = orders.get(order_id)
        if not order:
            logger.error(f"–ó–∞–∫–∞–∑ {order_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return False
        
        logger.info(f"–ò—â–µ–º –ø–ª–∞—Ç–µ–∂ –¥–ª—è –∑–∞–∫–∞–∑–∞ {order_id}")
        
        # –ü–æ–∏—Å–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
        to_date = datetime.now()
        from_date = to_date - timedelta(hours=1)
        from_date_str = from_date.strftime("%Y-%m-%dT%H:%M:%SZ")
        to_date_str = to_date.strftime("%Y-%m-%dT%H:%M:%SZ")
        
        headers = {'Authorization': f'Bearer {YMONEY_TOKEN}'}
        params = {
            'type': 'deposition',
            'from': from_date_str,
            'till': to_date_str,
            'records': '50'
        }
        
        response = requests.post(
            'https://yoomoney.ru/api/operation-history',
            headers=headers,
            data=params
        )
        
        if response.status_code == 200:
            operations = response.json().get('operations', [])
            
            for operation in operations:
                op_amount = float(operation.get('amount', 0))
                op_status = operation.get('status', '')
                op_direction = operation.get('direction', '')
                
                if (order['min_amount'] <= op_amount <= order['expected_amount'] and
                    op_status == 'success' and
                    op_direction == 'in'):
                    
                    logger.info(f"–ù–∞–π–¥–µ–Ω –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–ª–∞—Ç–µ–∂! –°—É–º–º–∞: {op_amount} —Ä—É–±")
                    return True
            
            logger.info("–ü–æ–¥—Ö–æ–¥—è—â–∏–π –ø–ª–∞—Ç–µ–∂ –Ω–µ –Ω–∞–π–¥–µ–Ω")
        else:
            logger.error(f"–û—à–∏–±–∫–∞ API: {response.status_code}")
            
        return False
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–ª–∞—Ç–µ–∂–∞: {e}")
        return False

async def button_handler(update: Update, context: CallbackContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏–π –Ω–∞ –∫–Ω–æ–ø–∫–∏"""
    query = update.callback_query
    await query.answer()
    
    if query.data.startswith("check_"):
        order_id = query.data.replace("check_", "")
        
        order = orders.get(order_id)
        if order and (time.time() - order['created_at']) < 30:
            await query.answer("‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ 30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã", show_alert=True)
            return
        
        checking_msg = await query.message.reply_text("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–ø–ª–∞—Ç—É...")
        is_paid = await check_yoomoney_payment(order_id)
        
        try:
            await context.bot.delete_message(
                chat_id=query.message.chat_id, 
                message_id=checking_msg.message_id
            )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        
        if is_paid:
            orders[order_id]['paid'] = True
            await query.message.reply_text(
                f"‚úÖ *–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!*\n\n"
                f"üíé *–í–æ—Ç –≤–∞—à–∞ –ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ç–∞–±–ª–∏—Ü—ã:*\n{FULL_SHEET_URL}\n\n"
                f"üìö *–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é:*\n"
                f"‚Ä¢ –í—Å–µ 3 —Ä–∞–∑–¥–µ–ª–∞ —Ç–∞–±–ª–∏—Ü—ã\n"
                f"‚Ä¢ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏\n"
                f"‚Ä¢ –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞–≤—Å–µ–≥–¥–∞\n\n"
                f"–ü—Ä–∏—è—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è! üìä",
                parse_mode='Markdown'
            )
        else:
            keyboard = [[InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—â–µ —Ä–∞–∑", callback_data=f"check_{order_id}")]]
            await query.message.reply_text(
                "‚ùå *–û–ø–ª–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.*\n\n"
                "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                "‚Ä¢ –ü–ª–∞—Ç–µ–∂ –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è (1-5 –º–∏–Ω—É—Ç)\n"
                "‚Ä¢ –ü—Ä–æ–±–ª–µ–º—ã —Å API\n\n"
                "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –ø–∞—Ä—É –º–∏–Ω—É—Ç:",
                reply_markup=InlineKeyboardMarkup(keyboard),
                parse_mode='Markdown'
            )

async def adjust_commission(update: Update, context: CallbackContext) -> None:
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    user_id = update.effective_user.id
    
    if user_id != ADMIN_ID:
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã")
        return
    
    if context.args:
        try:
            new_min_amount = int(context.args[0])
            global MIN_AMOUNT
            MIN_AMOUNT = new_min_amount
            await update.message.reply_text(f"‚úÖ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ {MIN_AMOUNT} —Ä—É–±")
        except ValueError:
            await update.message.reply_text("‚ùå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /commission <—Å—É–º–º–∞>")
    else:
        await update.message.reply_text(
            f"üìä –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∏—Å—Å–∏–∏:\n"
            f"–û–∂–∏–¥–∞–µ–º–∞—è —Å—É–º–º–∞: {EXPECTED_AMOUNT} —Ä—É–±\n"
            f"–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞: {MIN_AMOUNT} —Ä—É–±\n\n"
            f"–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /commission <–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è_—Å—É–º–º–∞>"
        )

async def get_my_id(update: Update, context: CallbackContext) -> None:
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ Telegram ID"""
    user_id = update.effective_user.id
    await update.message.reply_text(f"üÜî –í–∞—à Telegram ID: `{user_id}`", parse_mode='Markdown')

async def bot_status(update: Update, context: CallbackContext) -> None:
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –±–æ—Ç–∞"""
    status_text = (
        f"ü§ñ *–°—Ç–∞—Ç—É—Å –±–æ—Ç–∞*\n\n"
        f"‚Ä¢ –ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤: {len(orders)}\n"
        f"‚Ä¢ Self-ping: ‚úÖ –∞–∫—Ç–∏–≤–µ–Ω\n"
        f"‚Ä¢ –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: {round(time.time() - app_start_time, 0)} —Å–µ–∫\n"
        f"‚Ä¢ URL: https://{os.environ.get('REPL_SLUG', 'telegram-table-bot-belivernast')}.replit.app\n"
        f"‚Ä¢ Health check: /health\n"
        f"‚Ä¢ Ping: /ping"
    )
    await update.message.reply_text(status_text, parse_mode='Markdown')

def run_flask():
    """–ó–∞–ø—É—Å–∫ Flask —Å–µ—Ä–≤–µ—Ä–∞"""
    port = int(os.environ.get('PORT', 8080))
    app.run(host='0.0.0.0', port=port)

def main():
    global app_start_time
    app_start_time = time.time()
    
    logger.info("üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ —Å SELF-PING –º–µ—Ö–∞–Ω–∏–∑–º–æ–º...")
    logger.info(f"üí∞ –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è: {EXPECTED_AMOUNT} —Ä—É–±")
    logger.info(f"üëë Admin ID: {ADMIN_ID}")
    logger.info("üîÑ Self-ping –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Flask –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()
    logger.info("üåê Flask —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8080")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º Telegram –±–æ—Ç–∞
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("commission", adjust_commission))
    application.add_handler(CommandHandler("myid", get_my_id))
    application.add_handler(CommandHandler("status", bot_status))
    application.add_handler(CallbackQueryHandler(button_handler))
    
    logger.info("ü§ñ Telegram –±–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–ª–ª–∏–Ω–≥
    application.run_polling()

if __name__ == "__main__":
    main()
